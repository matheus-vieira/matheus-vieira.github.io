<p>Esse artigo faz parte de uma série de artigos sobre como utilizar o EFCore com múltiplos providers de banco de dados. Se quiser veja outras partes dessa série em <a href="#related">links relacionados</a>.</p>

<h2 id="configurando-banco-de-dados-em-um-projeto-net-core">Configurando banco de dados em um projeto .NET Core</h2>

<p>Neste ponto assumo que você já é familiarizado com projetos .NET e/ou .NET Core e portanto sabe implementar ou se necessário ler o site <a href="https://docs.microsoft.com/en-us/aspnet/core/?view=aspnetcore-3.1">AS.NET Documentation</a> para saber como iniciar a configuração de um banco de dados.</p>

<p>Aqui mostrarei uma possível ideia de implementação de um projeto de acesso a banco de dados.</p>

<p>Algo que acaba me incomodando é as pessoas utilizarem exemplos da própria documentação e manter isso por toda a vida do projeto.</p>

<p>Primeiro exemplo que quero apresentar é sobre como utilizar o princípio de responsabilidade única ao criarmos um projeto de banco de dados.</p>

<p>Sabemos que no método <code>ConfigureServices</code> da classe <code>Startup</code> precisamos, como o nome propõe, configurar nossos serviços, e nosso banco de dados é um serviço de nossa aplicação.</p>

<p>Aqui temos um exemplo da própria <a href="https://docs.microsoft.com/en-us/aspnet/core/data/ef-mvc/intro?view=aspnetcore-3.1#register-the-schoolcontext">documentação</a></p>

<pre><code class="language-csharp">public void ConfigureServices(IServiceCollection services)
{
    services.Configure&lt;CookiePolicyOptions&gt;(options =&gt;
    {
        options.CheckConsentNeeded = context =&gt; true;
        options.MinimumSameSitePolicy = SameSiteMode.None;
    });

    services.AddDbContext&lt;SchoolContext&gt;(options =&gt;
        options.UseSqlServer(Configuration.GetConnectionString("DefaultConnection")));

    services.AddMvc();
}
</code></pre>
<p><br />
O projeto que possui a classe <code>Startup</code> deve basicamente, se por exemplo o projeto for de uma API:</p>

<ul>
  <li>Carregar o(s) arquivo(s) de configuração</li>
  <li>Configurar as rotas</li>
  <li>E solicitar aos serviços para que eles configurem o que for necessário.</li>
</ul>

<p>O ponto chave do <code>ConfigureServices</code> é a chamada ao método (de extensão) <code>AddDbContext</code>, ao meu ver isso é algo que o próprio projeto de banco de dados deve ser o responsável pela sua configuração.</p>

<p>Para isso podemos utilizar um <a href="/blog/pt-br/dotnet-pro-tips/extension-methods">métodos de extensão</a> no projeto que faz sentido.</p>

<blockquote>
  <p>Caso seu sistema possua uma camada de serviço entre a controller e o banco de dados então a classe <code>Startup</code> deve conhecer apenas o a camada de serviço.</p>
</blockquote>

<p>Um exemplo de método de extensão:</p>

<pre><code class="language-csharp">namespace ContosoUniversity.Data.Extension
{
    public static class RepositoryExtension
    {
        public static void UseDataRepository(this IServiceCollection services, IConfiguration configuration)
        {
            services.AddDbContext&lt;SchoolContext&gt;(options =&gt;
                options.UseSqlServer(configuration.GetConnectionString("DefaultConnection")));
        }
    }
}
</code></pre>

<blockquote>
  <p>Eu acho interessante utilizar o prefixo <code>Use</code>, mas é gosto pessoal, pode usar o nome que desejar.</p>

  <p>O foco aqui é extender a interface <code>IServiceCollection</code> recebendo a interface <code>IConfiguration</code></p>
</blockquote>

<p>Agora podemos ver que a responsabilidade da <code>Startup</code> é pedir para o serviço se configurar:</p>

<pre><code class="language-csharp">// código omitido
using ContosoUniversity.Data.Extension; // não esqueça de adicionar o using para o método de extensã

// código omitido

public void ConfigureServices(IServiceCollection services)
{
    services.Configure&lt;CookiePolicyOptions&gt;(options =&gt;
    {
        options.CheckConsentNeeded = context =&gt; true;
        options.MinimumSameSitePolicy = SameSiteMode.None;
    });

    services.UseDataRepository(Configuration);

    services.AddMvc();
}
</code></pre>
<p><br />
Toda a complexidade foi removida da classe de inicialização e encapsulada dentro do projeto responsável.</p>

<p>Como comentado acima, caso o seu sistema possua uma camada de serviço a implementação deve seguir a mesma ideia.</p>

<pre><code class="language-csharp">namespace ContosoUniversity.ServiceLayer.Extension
{
    public static class ServiceLayerExtension
    {
        public static void UseServiceLayer(this IServiceCollection services, IConfiguration configuration)
        {
            // qualquer configuraçãp necessária
            
            // configurar o acesso ao banco
            services.UseDataRepository(Configuration);
        }
    }
}
</code></pre>
<p><br />
Com isso devemos apenas mudar nossa classe de <code>Startup</code> de forma a chamar o método que ele conhece</p>

<pre><code class="language-csharp">// código omitido
using ContosoUniversity.ServiceLayer.Extension; // não esqueça de adicionar o using para o método de extensã

// código omitido

public void ConfigureServices(IServiceCollection services)
{
    services.Configure&lt;CookiePolicyOptions&gt;(options =&gt;
    {
        options.CheckConsentNeeded = context =&gt; true;
        options.MinimumSameSitePolicy = SameSiteMode.None;
    });

    services.UseServiceLayer(Configuration);

    services.AddMvc();
}
</code></pre>
<p><br />
Perceba agora que temos todas as configurações em seus devidos lugares, portanto se ocorrer a necessidade de se reconfigurar algo (seja da camada de serviço ou de banco de dados) será uma configuração transaparente e somente quem é responsável fica sabendo da alteração.</p>

<p>Em outras palavras, nossa camada de API não sabe se os dados recebidos por ela e repassado à camada de serviço será gravados efetivamente em um banco de dados, ou se chamará outra API externa, isso não é responsabilidade da API.</p>

<h4 id="related">Links para artigos relacionados</h4>

<p><a href="/blog/pt-br/dotnet-pro-tips/intro/">.NET Pro tips Multiple Databases Providers Introduction</a></p>

<p><a href="/blog/pt-br/dotnet-pro-tips/extension-methods">Parte 1 - Métodos de extensão</a></p>

<p><a href="/blog/pt-br/dotnet-pro-tips/configuring-db">Parte 2 - Configurando o banco de dados</a></p>
